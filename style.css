const firebaseConfig = {
  apiKey: "AIzaSyDbtL7jHyQYRD4NiWSJELp8doinnL5U1vM",
  authDomain: "pestrap-demo.firebaseapp.com",
  databaseURL: "https://pestrap-demo-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pestrap-demo",
  storageBucket: "pestrap-demo.firebasestorage.app",
  messagingSenderId: "654436801113",
  appId: "1:654436801113:web:c0e8026b48b85905952f48"
};
// Inisialisasi Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Path baru berdasarkan struktur di Firebase
const PATHS = {
  gauge: "/device1/irCount",
  statusNeon: "/device1/relay",
  totalKumbang: "/device1/irCount", // bisa juga beda kalau mau
  time: "/device1/time",
  lastUpdate: "/lastUpdate"
};

// Elemen UI
const gaugeValueEl = document.getElementById("gaugeValue");
const arcEl = document.getElementById("arc");
const statusEl = document.getElementById("statusNeon");
const totalEl = document.getElementById("totalKumbang");
const lastUpdateEl = document.getElementById("lastUpdate");
const connStateEl = document.getElementById("connState");

// Fungsi buat gauge
const ARC_LENGTH = 252;
function setGauge(value) {
  const v = Math.max(0, Math.min(100, Number(value || 0)));
  const draw = Math.round(ARC_LENGTH * (v / 100));
  arcEl.setAttribute("stroke-dasharray", `${draw} ${ARC_LENGTH}`);
  gaugeValueEl.textContent = v;
}

// Monitor koneksi
firebase.database().ref(".info/connected").on("value", (snap) => {
  const connected = snap.val();
  connStateEl.textContent = connected ? "connected" : "disconnected";
  connStateEl.style.color = connected ? "#a9ffb8" : "#ffb0b0";
});

// Ambil data irCount â†’ tampilkan ke gauge dan total
db.ref(PATHS.gauge).on("value", (snap) => {
  const val = snap.val() || 0;
  setGauge(val);
  totalEl.textContent = val;
  updateLast();
});

// Ambil status relay
db.ref(PATHS.statusNeon).on("value", (snap) => {
  const val = snap.val();
  statusEl.textContent = val ? "ON" : "OFF";
  updateLast();
});

// Ambil waktu terakhir
db.ref(PATHS.time).on("value", (snap) => {
  const val = snap.val();
  if (val) lastUpdateEl.textContent = val;
});

// Update timestamp
function updateLast() {
  const ts = Date.now();
  db.ref(PATHS.lastUpdate).set(ts).catch(() => {});
}

// Tombol image
document.getElementById("imgBtn1").addEventListener("click", () => {
  sendCommand("btn1");
});
document.getElementById("imgBtn2").addEventListener("click", () => {
  sendCommand("btn2");
});

function sendCommand(name) {
  db.ref("/commands").push({ cmd: name, ts: Date.now() }).catch((err) => {
    console.error("Failed to send command", err);
  });
}

// Inisialisasi
setGauge(0);
